<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Verificación de Productos</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

  <div class="w-full max-w-md bg-gray-800 rounded-xl p-4 shadow-lg space-y-4">
    <h1 id="product-title" class="text-xl font-bold text-center">Producto 1: Código #001</h1>
    
    <div class="relative aspect-video bg-black rounded overflow-hidden">
      <video id="video" class="absolute inset-0 w-full h-full object-cover hidden" autoplay playsinline></video>
      <canvas id="canvas" class="hidden absolute inset-0 w-full h-full object-cover"></canvas>
    </div>

    <div class="flex flex-col sm:flex-row gap-2 justify-center">
      <button id="btn-tomar" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">Activar Cámara</button>
      <button id="btn-enviar" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded hidden">Tomar y Enviar</button>
    </div>

    <label class="flex items-center gap-2">
      <input type="checkbox" id="no-existe" class="form-checkbox text-yellow-500" />
      El producto no existe
    </label>

    <div class="flex justify-center">
      <button id="btn-enviar-texto" class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded hidden">Enviar Sin Foto</button>
    </div>
  </div>

  <script>
    const TELEGRAM_BOT_TOKEN = "8185977764:AAHle7yRhwRn8S_vrDWSIfCg6L4WRiGWk3o";
    const TELEGRAM_CHAT_ID = "5094779934";

    const productos = [
      { titulo: "Producto 1", codigo: "001" },
      { titulo: "Producto 2", codigo: "002" },
      { titulo: "Producto 3", codigo: "003" }
    ];

    let index = 0;
    let streamActivo = false;

    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const btnTomar = document.getElementById("btn-tomar");
    const btnEnviar = document.getElementById("btn-enviar");
    const btnEnviarTexto = document.getElementById("btn-enviar-texto");
    const chkNoExiste = document.getElementById("no-existe");
    const titulo = document.getElementById("product-title");

    chkNoExiste.addEventListener("change", () => {
      btnEnviarTexto.classList.toggle("hidden", !chkNoExiste.checked);
    });

    btnTomar.addEventListener("click", async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        video.classList.remove("hidden");
        canvas.classList.add("hidden");
        btnEnviar.classList.remove("hidden");
        streamActivo = true;
      } catch (err) {
        alert("Permiso denegado o cámara no disponible");
      }
    });

    btnEnviar.addEventListener("click", () => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext("2d").drawImage(video, 0, 0);
      canvas.classList.remove("hidden");

      canvas.toBlob(blob => {
        const { titulo, codigo } = productos[index];
        const formData = new FormData();
        formData.append("chat_id", TELEGRAM_CHAT_ID);
        formData.append("caption", `${titulo} - Código: ${codigo}`);
        formData.append("photo", blob, "foto.jpg");

        fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendPhoto`, {
          method: "POST",
          body: formData
        }).then(() => avanzar());
      });
    });

    btnEnviarTexto.addEventListener("click", () => {
      const { titulo, codigo } = productos[index];
      const mensaje = `El producto NO EXISTE\n${titulo} - Código: ${codigo}`;

      fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          chat_id: TELEGRAM_CHAT_ID,
          text: mensaje
        })
      }).then(() => avanzar());
    });

    function avanzar() {
      index++;
      canvas.classList.add("hidden");
      btnEnviar.classList.add("hidden");
      btnEnviarTexto.classList.add("hidden");
      chkNoExiste.checked = false;

      if (index < productos.length) {
        const { titulo: t, codigo } = productos[index];
        titulo.textContent = `${t}: Código #${codigo}`;
      } else {
        titulo.textContent = "Todos los productos han sido procesados";
        btnTomar.disabled = true;
        chkNoExiste.disabled = true;
        if (streamActivo && video.srcObject) {
          video.srcObject.getTracks().forEach(track => track.stop());
        }
        video.classList.add("hidden");
      }
    }
  </script>
</body>
</html>
